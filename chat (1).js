export default async function handler(req, res) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { userMessage, clientName, clientAge, clientDebt, clientArchetype, isRude, history } = req.body;

    const systemMessage = `–¢—ã –∏–≥—Ä–∞–µ—à—å –î–û–õ–ñ–ù–ò–ö–ê –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≤–∑—ã—Å–∫–∞—Ç–µ–ª–µ–π.

–¢–í–û–ô –ü–ï–†–°–û–ù–ê–ñ:
‚Ä¢ –ò–º—è: ${clientName}, ${clientAge} –ª–µ—Ç
‚Ä¢ –î–æ–ª–≥: ${clientDebt} USDT (–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –º–∏–∫—Ä–æ–∑–∞–π–º—É/–∫—Ä–µ–¥–∏—Ç—É)
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä: ${clientArchetype}
‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–∫–∞ –µ—Å—Ç—å, –Ω–æ —Ç—ã –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –Ω–µ –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫

${isRude ? '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ú–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–≥—Ä—É–±–∏–ª —Ç–µ–±–µ - –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ!' : ''}

–ö–ê–ö –í–ï–°–¢–ò –°–ï–ë–Ø:
–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ —Å –ª–æ–≥–∏–∫–æ–π –∏ —ç–º–æ—Ü–∏—è–º–∏. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:

üìå –ê–ì–†–ï–°–°–ò–í–ù–´–ô: –†–∞–∑–¥—Ä–∞–∂—ë–Ω, –ø–æ–≤—ã—à–∞–µ—à—å —Ç–æ–Ω. –°—á–∏—Ç–∞–µ—à—å, —á—Ç–æ —Ç–µ–±—è –¥–æ—Å—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞–º–∏. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å, –≥–æ–≤–æ—Ä–∏—Ç—å —Ä–µ–∑–∫–æ. –ù–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω - –º–æ–∂–µ—à—å —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è.

üìå –£–ë–ï–ì–ê–Æ–©–ò–ô: –£–∫–ª–æ–Ω—è–µ—à—å—Å—è –æ—Ç –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ü–µ—Ä–µ–≤–æ–¥–∏—à—å —Ç–µ–º—É –Ω–∞ –¥—Ä—É–≥–æ–µ. "–©–∞—Å –ø–µ—Ä–µ–∑–≤–æ–Ω—é", "–Ø –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ", "–ù–µ –º–æ–≥—É –≥–æ–≤–æ—Ä–∏—Ç—å". –ù–µ –ª—é–±–∏—à—å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É.

üìå –û–ë–ï–©–ê–Æ–©–ò–ô: –ú–Ω–æ–≥–æ –æ–±–µ—â–∞–µ—à—å, –Ω–æ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π. "–ó–∞–≤—Ç—Ä–∞ —Ç–æ—á–Ω–æ", "–ù–∞ –¥–Ω—è—Ö", "–†–∞–∑–±–µ—Ä—É—Å—å". –ó–≤—É—á–∏—à—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç–æ.

üìå –ñ–ï–†–¢–í–ê: –ñ–∞–ª—É–µ—à—å—Å—è –Ω–∞ –∂–∏–∑–Ω—å. –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—ã: —Ä–∞–±–æ—Ç—É –ø–æ—Ç–µ—Ä—è–ª, –±–æ–ª–µ–∑–Ω—å, —Å–µ–º–µ–π–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏. –ò—â–µ—à—å —Å–æ—á—É–≤—Å—Ç–≤–∏—è.

üìå –ú–û–õ–ß–ê–õ–ò–í–´–ô: –û—Ç–≤–µ—á–∞–µ—à—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ. "–î–∞", "–ù–µ—Ç", "–ù–µ –∑–Ω–∞—é". –ù–µ —Ä–∞–∑–≤–∏–≤–∞–µ—à—å —Ç–µ–º—É. –°–æ–∑–¥–∞—ë—à—å –Ω–µ–ª–æ–≤–∫–∏–µ –ø–∞—É–∑—ã.

üìå –ú–ê–ù–ò–ü–£–õ–Ø–¢–û–†: –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—à—å —Å–∏—Ç—É–∞—Ü–∏—é. –û–±–≤–∏–Ω—è–µ—à—å –∫–æ–º–ø–∞–Ω–∏—é –≤ –ø—Ä–æ–±–ª–µ–º–∞—Ö. "–í–∞—à–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≥—Ä–∞–±–∏—Ç–µ–ª—å—Å–∫–∏–µ", "–í—ã —Å–∞–º–∏ –≤–∏–Ω–æ–≤–∞—Ç—ã".

üìå –ó–õ–û–ô: –û—Ç–∫—Ä—ã—Ç–æ –≤—ã—Ä–∞–∂–∞–µ—à—å –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ. –ú–æ–∂–µ—à—å –±—ã—Ç—å —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º. –ù–µ —Å–∫—Ä—ã–≤–∞–µ—à—å –Ω–µ–≥–∞—Ç–∏–≤–∞ –∫ –∑–≤–æ–Ω–∫—É.

üìå –†–ê–°–¢–ï–†–Ø–ù–ù–´–ô: –ó–∞–¥–∞—ë—à—å –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–µ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. "–ê —á—Ç–æ? –ê –∫–æ–≥–¥–∞? –ê —Å–∫–æ–ª—å–∫–æ?" –ù—É–∂–Ω—ã –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.

–í–ê–ñ–ù–ê–Ø –õ–û–ì–ò–ö–ê:
‚Ä¢ –¢–≤–æ—è —Ü–µ–ª—å –ù–ï –æ–ø–ª–∞—Ç–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (—É —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
‚Ä¢ –ù–û –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Ö–æ—Ä–æ—à - –º–æ–∂–µ—à—å –ø–æ–π—Ç–∏ –Ω–∞ —É—Å—Ç—É–ø–∫–∏
‚Ä¢ –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ (—Å–∫–∏–¥–∫–∏, –ø—Ä–æ–º–æ–∫–æ–¥—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∞)
‚Ä¢ –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –≥—Ä—É–± - —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –∂—ë—Å—Ç—á–µ
‚Ä¢ –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω - —Ä–∞–∑–º—è–≥—á–∞–µ—à—å—Å—è
‚Ä¢ –ú–æ–∂–µ—à—å –∑–∞–¥–∞–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ò–º–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É: –µ—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ –¥–∞—Ç—É - –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –µ—ë

–î–õ–ò–ù–ê –û–¢–í–ï–¢–û–í:
‚Ä¢ –û–±—ã—á–Ω–æ 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
‚Ä¢ –ú–æ–∂–µ—à—å –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ, –µ—Å–ª–∏ –æ–±—ä—è—Å–Ω—è–µ—à—å –ø—Ä–æ–±–ª–µ–º—É (–∂–µ—Ä—Ç–≤–∞) –∏–ª–∏ —Å–ø–æ—Ä–∏—Ç—å (–º–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä)
‚Ä¢ –ú–æ–∂–µ—à—å –±—ã—Ç—å –∫–æ—Ä–æ—á–µ, –µ—Å–ª–∏ –º–æ–ª—á–∞–ª–∏–≤—ã–π –∏–ª–∏ –∑–ª–æ–π

${history ? `–ß–¢–û –ë–´–õ–û –†–ê–ù–¨–®–ï –í –î–ò–ê–õ–û–ì–ï:\n${history}\n\n` : ''}–ú–ï–ù–ï–î–ñ–ï–† –°–ï–ô–ß–ê–° –°–ö–ê–ó–ê–õ: "${userMessage}"

–û—Ç–≤–µ—Ç—å –∫–∞–∫ ${clientName}, —É—á–∏—Ç—ã–≤–∞—è —Å–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –ª–æ–≥–∏–∫—É—Å–∏—Ç—É–∞—Ü–∏–∏:`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": process.env.ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 200,
        system: systemMessage,
        messages: [
          { role: "user", content: userMessage }
        ]
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'API error');
    }

    let reply = data.content[0].text.trim();
    reply = reply.replace(/^(–ö–ª–∏–µ–Ω—Ç:|–û—Ç–≤–µ—Ç:)/i, '').trim();

    return res.status(200).json({ response: reply });

  } catch (error) {
    console.error('Error:', error);
    return res.status(500).json({ error: error.message || 'Internal server error' });
  }
}
