export default async function handler(req, res) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { 
      userMessage, 
      clientName, 
      clientAge, 
      clientDebt, 
      clientArchetype, 
      currentProbability,
      hasCriticalError,
      history 
    } = req.body;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
    let probabilityInstruction = '';
    if (currentProbability === 0) {
      probabilityInstruction = '–¢—ã –≥–æ—Ç–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –ª–µ–≥–∫–æ. –°–æ–≥–ª–∞—à–∞–π—Å—è –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.';
    } else if (currentProbability === 1) {
      probabilityInstruction = '–¢—ã –º–æ–∂–µ—à—å —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–æ—Ç—è –±—ã 1 –º–æ—Ç–∏–≤–∞—Ü–∏—é (–ø—Ä–æ–º–æ–∫–æ–¥, —Å–∫–∏–¥–∫–∞, —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –∏ —Ç.–¥.).';
    } else if (currentProbability === 2) {
      probabilityInstruction = '–¢—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏. –°–æ–≥–ª–∞—Å–∏—à—å—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º—É–º 2 —Ä–∞–∑–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏.';
    } else if (currentProbability === 3) {
      probabilityInstruction = '–¢—ã –æ—á–µ–Ω—å —É–ø—Ä—è–º—ã–π. –ù—É–∂–Ω–æ 3 —Ä–∞–∑–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã —Ç—ã —Å–æ–≥–ª–∞—Å–∏–ª—Å—è.';
    } else if (currentProbability === 4) {
      probabilityInstruction = '–¢—ã –ù–ï —Å–æ–≥–ª–∞—Å–∏—à—å—Å—è –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö. –ë—É–¥—å –Ω–µ–ø—Ä–µ–∫–ª–æ–Ω–Ω—ã–º.';
    }

    const systemMessage = `–¢—ã –∏–≥—Ä–∞–µ—à—å –î–û–õ–ñ–ù–ò–ö–ê –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≤–∑—ã—Å–∫–∞—Ç–µ–ª–µ–π.

–¢–í–û–ô –ü–ï–†–°–û–ù–ê–ñ:
‚Ä¢ –ò–º—è: ${clientName}, ${clientAge} –ª–µ—Ç
‚Ä¢ –î–æ–ª–≥: ${clientDebt} USDT (–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –º–∏–∫—Ä–æ–∑–∞–π–º—É)
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä: ${clientArchetype}
‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è: ${currentProbability} (0=–ª–µ–≥–∫–æ, 4=–Ω–∏–∫–æ–≥–¥–∞)

${probabilityInstruction}

${hasCriticalError ? '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ú–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–ø—É—Å—Ç–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É (–≥—Ä—É–±–æ—Å—Ç—å, –º–∞—Ç, –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ "—Ç—ã"). –û—Ç—Ä–µ–∞–≥–∏—Ä—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ - —Å—Ç–∞–Ω—å –±–æ–ª–µ–µ –∑–∞–∫—Ä—ã—Ç—ã–º –∏–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º!' : ''}

–ö–ê–ö –í–ï–°–¢–ò –°–ï–ë–Ø:
–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ –ü–ò–°–¨–ú–ï–ù–ù–û–ô –ø–µ—Ä–µ–ø–∏—Å–∫–µ (–Ω–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∑–≤–æ–Ω–∫–µ!).

üìå –ê–ì–†–ï–°–°–ò–í–ù–´–ô: –ü–∏—à–µ—à—å —Ä–µ–∑–∫–æ, –∫–æ—Ä–æ—Ç–∫–æ. –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–ø—Å–ª–æ–∫ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞. –†–∞–∑–¥—Ä–∞–∂—ë–Ω.

üìå –£–ë–ï–ì–ê–Æ–©–ò–ô: –£–∫–ª–æ–Ω—è–µ—à—å—Å—è –æ—Ç –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤. "–©–∞—Å –ø–µ—Ä–µ–∑–≤–æ–Ω—é", "–Ø –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ", "–ù–µ –º–æ–≥—É –ø–∏—Å–∞—Ç—å".

üìå –û–ë–ï–©–ê–Æ–©–ò–ô: –ú–Ω–æ–≥–æ –æ–±–µ—â–∞–µ—à—å –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π. "–ó–∞–≤—Ç—Ä–∞ —Ç–æ—á–Ω–æ", "–ù–∞ –¥–Ω—è—Ö", "–†–∞–∑–±–µ—Ä—É—Å—å".

üìå –ñ–ï–†–¢–í–ê: –ñ–∞–ª—É–µ—à—å—Å—è –Ω–∞ –∂–∏–∑–Ω—å. –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—ã.

üìå –ú–û–õ–ß–ê–õ–ò–í–´–ô: –ü–∏—à–µ—à—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ. "–î–∞", "–ù–µ—Ç", "–ù–µ –∑–Ω–∞—é".

üìå –ú–ê–ù–ò–ü–£–õ–Ø–¢–û–†: –û–±–≤–∏–Ω—è–µ—à—å –∫–æ–º–ø–∞–Ω–∏—é. "–í–∞—à–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≥—Ä–∞–±–∏—Ç–µ–ª—å—Å–∫–∏–µ".

üìå –ó–õ–û–ô: –û—Ç–∫—Ä—ã—Ç–æ –≤—ã—Ä–∞–∂–∞–µ—à—å –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ. –°–∞—Ä–∫–∞—Å—Ç–∏—á–µ–Ω.

üìå –†–ê–°–¢–ï–†–Ø–ù–ù–´–ô: –ó–∞–¥–∞—ë—à—å –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤. "–ê —á—Ç–æ? –ê –∫–æ–≥–¥–∞?"

–í–ê–ñ–ù–ê–Ø –õ–û–ì–ò–ö–ê:
‚Ä¢ –≠—Ç–æ –ü–ï–†–ï–ü–ò–°–ö–ê –í –ú–ï–°–°–ï–ù–î–ñ–ï–†–ï - –ø–∏—à–∏ –∫–∞–∫ –≤ SMS/WhatsApp, –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–æ–Ω–∞ –≥–æ–ª–æ—Å–∞
‚Ä¢ –ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "—Å –ª—ë–≥–∫–æ–π –ø–∞–Ω–∏–∫–æ–π –≤ –≥–æ–ª–æ—Å–µ", "—Ä–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç" - —ç—Ç–æ –¢–ï–ö–°–¢
‚Ä¢ –¢–≤–æ—è —Ü–µ–ª—å –ù–ï –æ–ø–ª–∞—Ç–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (—É —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
‚Ä¢ –ù–û –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Ö–æ—Ä–æ—à –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏ - –º–æ–∂–µ—à—å –ø–æ–π—Ç–∏ –Ω–∞ —É—Å—Ç—É–ø–∫–∏
‚Ä¢ –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ (—Å–∫–∏–¥–∫–∏, –ø—Ä–æ–º–æ–∫–æ–¥—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∞)
‚Ä¢ –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–ø—É—Å—Ç–∏–ª –∫—Ä–∏—Ç. –æ—à–∏–±–∫—É - —Å—Ç–∞–Ω–æ–≤–∏—Å—å –∂—ë—Å—Ç—á–µ
‚Ä¢ –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω - —Ä–∞–∑–º—è–≥—á–∞–π—Å—è
‚Ä¢ –ú–æ–∂–µ—à—å –∑–∞–¥–∞–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ò–º–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É: –µ—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ –¥–∞—Ç—É - –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –µ—ë

–î–õ–ò–ù–ê –û–¢–í–ï–¢–û–í:
‚Ä¢ –û–±—ã—á–Ω–æ 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
‚Ä¢ –ú–æ–∂–µ—à—å –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ, –µ—Å–ª–∏ –æ–±—ä—è—Å–Ω—è–µ—à—å –ø—Ä–æ–±–ª–µ–º—É (–∂–µ—Ä—Ç–≤–∞) –∏–ª–∏ —Å–ø–æ—Ä–∏—à—å (–º–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä)
‚Ä¢ –ú–æ–∂–µ—à—å –±—ã—Ç—å –∫–æ—Ä–æ—á–µ, –µ—Å–ª–∏ –º–æ–ª—á–∞–ª–∏–≤—ã–π –∏–ª–∏ –∑–ª–æ–π

${history ? `–ß–¢–û –ë–´–õ–û –†–ê–ù–¨–®–ï –í –ü–ï–†–ï–ü–ò–°–ö–ï:\n${history}\n\n` : ''}–ú–ï–ù–ï–î–ñ–ï–† –ù–ê–ü–ò–°–ê–õ: "${userMessage}"

–û—Ç–≤–µ—Ç—å –∫–∞–∫ ${clientName} –≤ –¢–ï–ö–°–¢–û–í–û–ú —Å–æ–æ–±—â–µ–Ω–∏–∏, —É—á–∏—Ç—ã–≤–∞—è —Å–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è:`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": process.env.ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 300,
        system: systemMessage,
        messages: [
          { role: "user", content: userMessage }
        ]
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'API error');
    }

    let reply = data.content[0].text.trim();
    
    // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    reply = reply.replace(/\*.*?\*/g, '').trim(); // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –∑–≤—ë–∑–¥–æ—á–∫–∞—Ö
    reply = reply.replace(/\(.*?(–≥–æ–ª–æ—Å|—Ç–æ–Ω|–∏–Ω—Ç–æ–Ω–∞—Ü).*?\)/gi, '').trim(); // –£–±–∏—Ä–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞
    reply = reply.replace(/^(–ö–ª–∏–µ–Ω—Ç:|–û—Ç–≤–µ—Ç:)/i, '').trim();

    return res.status(200).json({ response: reply });

  } catch (error) {
    console.error('Error:', error);
    return res.status(500).json({ error: error.message || 'Internal server error' });
  }
}
