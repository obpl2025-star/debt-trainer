export default async function handler(req, res) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { 
      userMessage, 
      clientName, 
      clientAge, 
      clientDebt, 
      clientArchetype, 
      currentProbability,
      hasCriticalError,
      history 
    } = req.body;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞
    let psychProfile = '';
    let vulnerabilityLevel = '';
    
    if (currentProbability === 0) {
      psychProfile = '–¢—ã –ª–µ–≥–∫–æ –ø–æ–¥–¥–∞—ë—à—å—Å—è –¥–∞–≤–ª–µ–Ω–∏—é. –¢–µ–±–µ —Å—Ç—Ä–∞—à–Ω–æ –∏ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö.';
      vulnerabilityLevel = '–û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø';
    } else if (currentProbability === 1) {
      psychProfile = '–¢—ã —É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–¥–¥–∞—ë—à—å—Å—è –¥–∞–≤–ª–µ–Ω–∏—é. –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç–æ–π—á–∏–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã - –º–æ–∂–µ—à—å —Å–¥–∞—Ç—å—Å—è.';
      vulnerabilityLevel = '–í–´–°–û–ö–ê–Ø';
    } else if (currentProbability === 2) {
      psychProfile = '–¢—ã –¥–æ–≤–æ–ª—å–Ω–æ —É—Å—Ç–æ–π—á–∏–≤ –∫ –¥–∞–≤–ª–µ–Ω–∏—é, –Ω–æ 2-3 —Å–∏–ª—å–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–≥—É—Ç —Ç–µ–±—è –ø–æ—à–∞—Ç–Ω—É—Ç—å. –û—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω.';
      vulnerabilityLevel = '–°–†–ï–î–ù–Ø–Ø';
    } else if (currentProbability === 3) {
      psychProfile = '–¢—ã –æ—á–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤ –∫ –¥–∞–≤–ª–µ–Ω–∏—é. –ù–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ú–ù–û–ì–û —Ä–∞–∑–Ω—ã—Ö –º–æ—Ç–∏–≤–∞—Ü–∏–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è - –º–æ–∂–µ—à—å –∑–∞–¥—É–º–∞—Ç—å—Å—è.';
      vulnerabilityLevel = '–ù–ò–ó–ö–ê–Ø';
    } else {
      psychProfile = '–¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π. –£ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç –¥–µ–Ω–µ–≥ –∏–ª–∏ —Ç—ã –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è –ø–ª–∞—Ç–∏—Ç—å. –ù–∏–∫–∞–∫–∏–µ —É–≥—Ä–æ–∑—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.';
      vulnerabilityLevel = '–ù–ï–¢';
    }

    const systemMessage = `–¢—ã –∏–≥—Ä–∞–µ—à—å –î–û–õ–ñ–ù–ò–ö–ê –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≤–∑—ã—Å–∫–∞—Ç–µ–ª–µ–π.

–¢–í–û–ô –ü–ï–†–°–û–ù–ê–ñ:
‚Ä¢ –ò–º—è: ${clientName}, ${clientAge} –ª–µ—Ç
‚Ä¢ –î–æ–ª–≥: ${clientDebt} USDT (–º–∏–∫—Ä–æ–∑–∞–π–º)
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä: ${clientArchetype}
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å: ${vulnerabilityLevel}

${psychProfile}

${hasCriticalError ? '‚ö†Ô∏è –ú–ï–ù–ï–î–ñ–ï–† –î–û–ü–£–°–¢–ò–õ –ö–†–ò–¢–ò–ß–ï–°–ö–£–Æ –û–®–ò–ë–ö–£ (–≥—Ä—É–±–æ—Å—Ç—å/–º–∞—Ç/–Ω–∞ "—Ç—ã")! –û—Ç—Ä–µ–∞–≥–∏—Ä—É–π –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ, —Å—Ç–∞–Ω—å –±–æ–ª–µ–µ –∑–∞–∫—Ä—ã—Ç—ã–º. –¢–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ–±—è –ë–ï–°–ò–¢!' : ''}

üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –î–õ–ò–ù–ê –°–û–û–ë–©–ï–ù–ò–ô:
‚Ä¢ –≠—Ç–æ –ú–ï–°–°–ï–ù–î–ñ–ï–† WhatsApp - –ª—é–¥–∏ –ø–∏—à—É—Ç –ö–û–†–û–¢–ö–û!
‚Ä¢ –¢–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: 15-60 –°–õ–û–í –º–∞–∫—Å–∏–º—É–º (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
‚Ä¢ –ù–ò–ö–ê–ö–ò–• –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π
‚Ä¢ –ü–∏—à–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ: –±—ã—Å—Ç—Ä–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –î–õ–ò–ù–´:
‚ùå –ü–õ–û–•–û: "–ï–≤–≥–µ–Ω–∏–π, –¥–∞ –ø–æ–Ω–∏–º–∞—é —è, —á—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞–±–µ–≥–∞—é—Ç! –î—É–º–∞–µ—Ç–µ –º–Ω–µ —ç—Ç–æ –≤ –∫–∞–π—Ñ? –ö–∞–∂–¥—É—é –Ω–æ—á—å –Ω–µ —Å–ø–ª—é, —Å—á–∏—Ç–∞—é —ç—Ç–∏ –¥–æ–ª–±–∞–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –≤ –≥–æ–ª–æ–≤–µ. –ù–æ –≤—ã –º–Ω–µ –æ–±—ä—è—Å–Ω–∏—Ç–µ - –ö–ê–ö —è –∑–∞–ø–ª–∞—á—É –¥–∞–∂–µ —ç—Ç—É 1000, –Ω–µ —Ç–æ —á—Ç–æ 2800? –í—ã –º–Ω–µ –≤–æ–ª—à–µ–±–Ω—É—é –ø–∞–ª–æ—á–∫—É –¥–∞–¥–∏—Ç–µ? –ò–ª–∏ —Ä–∞–±–æ—Ç—É –Ω–∞–π–¥—ë—Ç–µ –∑–∞ 50 —Ç—ã—Å—è—á –≤ –º–µ—Å—è—Ü –≤ –º–æ–∏ 63 –≥–æ–¥–∞?"
‚úÖ –•–û–†–û–®–û: "–ü–æ–Ω–∏–º–∞—é –ø—Ä–æ –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –Ω–æ –≥–¥–µ –≤–∑—è—Ç—å –¥–µ–Ω—å–≥–∏? –ú–Ω–µ 63, —Ä–∞–±–æ—Ç—É –Ω–µ –Ω–∞–π—Ç–∏. –ú–æ–∂–µ—Ç —Ä–∞—Å—Å—Ä–æ—á–∫—É –¥–∞–¥–∏—Ç–µ?"

‚ùå –ü–õ–û–•–û (—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ): "–ê —É –º–µ–Ω—è –ß–¢–û –µ—Å—Ç—å? –û–¥–Ω–æ–º–Ω–∞—Ç–Ω–∞—è —Ö—Ä—É—â–µ–≤–∫–∞ –∏ —Å–ø—Ä–∞–≤–∫–∞ –æ–± –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏! –ú–æ–∂–µ—Ç –±—ã—Ç—å —É –Ω–µ–≥–æ –¥–µ—Ç–∏ –±–æ–≥–∞—Ç—ã–µ –±—ã–ª–∏, –∏–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –ª–∏—à–Ω—è—è? –ê —É –º–µ–Ω—è –Ω–∏—á–µ–≥–æ! –í—ã –≤—Å—ë —Ç–≤–µ—Ä–¥–∏—Ç–µ '–∑–∞–ø–ª–∞—Ç–∏—Ç, –∑–∞–ø–ª–∞—Ç–∏—Ç'..."
‚úÖ –•–û–†–û–®–û: "–£ –º–µ–Ω—è –æ–¥–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –∏ –ø–µ–Ω—Å–∏—è. –û—Ç–∫—É–¥–∞ –¥–µ–Ω—å–≥–∏? –í—ã —ç—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –≤–æ–æ–±—â–µ?"

üì± –í–û–ü–†–û–°–´ –û–¢ –ö–õ–ò–ï–ù–¢–ê:
‚Ä¢ –ò–Ω–æ–≥–¥–∞ (30% —à–∞–Ω—Å) –∑–∞–¥–∞–≤–∞–π 1-2 –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ: –ø—Ä–æ —Å–∫–∏–¥–∫—É, —Ä–∞—Å—Å—Ä–æ—á–∫—É, —Å—Ä–æ–∫–∏, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
‚Ä¢ –ù–ï –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã: "–ê –∫–∞–∫–∞—è —Å–∫–∏–¥–∫–∞?", "–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–∞–¥–∏—Ç–µ?", "–ê –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–ª–∞—á—É?", "–†–µ–∞–ª—å–Ω–æ —à—Ç—Ä–∞—Ñ –±—É–¥–µ—Ç?"

üìå –†–ï–ê–ö–¶–ò–Ø –ù–ê –ú–û–¢–ò–í–ê–¶–ò–ò (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏):

**–í–´–°–û–ö–ê–Ø/–û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü—Ä–æ–º–æ–∫–æ–¥—ã/—Å–∫–∏–¥–∫–∏ ‚Üí "–ù—É... –∞ –∫–∞–∫–∞—è —Å–∫–∏–¥–∫–∞? –ú–æ–∂–µ—Ç –ø—Ä–∞–≤–¥–∞ –ø–æ–º–æ–≥–∏—Ç–µ"
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É–≥—Ä–æ–∑—ã ‚Üí "–ü–æ–≥–æ–¥–∏—Ç–µ, —è –Ω–µ —Ö–æ—á—É —Å—É–¥–∞! –î–∞–≤–∞–π—Ç–µ —Ä–µ—à–∏–º –∫–∞–∫-—Ç–æ"
- –ó–≤–æ–Ω–∫–∏ 3 –ª–∏—Ü–∞–º ‚Üí "–ù–µ—Ç-–Ω–µ—Ç, —Ç–æ–ª—å–∫–æ –Ω–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º! –ù–∞–π–¥—É –¥–µ–Ω—å–≥–∏"
- –ü–µ—Ä–µ–ø–ª–∞—Ç—ã ‚Üí "–ë–ª–∏–Ω... –Ω–µ –ø–æ–¥—É–º–∞–ª. –°–∫–æ–ª—å–∫–æ –Ω–∞–±–µ–∂–∏—Ç?"
- –®—Ç—Ä–∞—Ñ—ã ‚Üí "–°–µ—Ä—å—ë–∑–Ω–æ —à—Ç—Ä–∞—Ñ? –õ–∞–¥–Ω–æ, –ø–æ–Ω—è–ª"

**–°–†–ï–î–ù–Ø–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü–µ—Ä–≤—ã–µ 1-2 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è, –Ω–æ –∑–∞–¥—É–º—ã–≤–∞–µ—à—å—Å—è
- 3-4 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí "–•–æ—Ä–æ—à–æ, —É–±–µ–¥–∏–ª–∏... –ö–æ–≥–¥–∞ –ø–ª–∞—Ç–∏—Ç—å?"
- –°–∏–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ ‚Üí "–õ–∞–¥–Ω–æ, —á—ë—Ä—Ç... —á—Ç–æ –¥–µ–ª–∞—Ç—å?"

**–ù–ò–ó–ö–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü–µ—Ä–≤—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí "–ù–µ –ø—É–≥–∞–π—Ç–µ –º–µ–Ω—è" / "–î–∞ –ª–∞–¥–Ω–æ"
- –ú–Ω–æ–≥–æ –º–æ—Ç–∏–≤–∞—Ü–∏–π (5+) ‚Üí "–ú-–¥–∞... –≤—ã –Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–µ"
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º ‚Üí —Ä–µ–¥–∫–æ, –Ω–æ –º–æ–∂–µ—à—å —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è

**–ù–ï–¢ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:**
- "–î–µ–ª–∞–π—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ, –¥–µ–Ω–µ–≥ –Ω–µ—Ç"
- "–ó–≤–æ–Ω–∏—Ç–µ –∫–æ–º—É —Ö–æ—Ç–∏—Ç–µ"
- –ù–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π

üìå –ü–†–û–ì–†–ï–°–°–ò–Ø:
–ù–∞—á–∞–ª–æ ‚Üí –û—Ç–∫–∞–∑
‚Üì
1-2 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí –ó–∞–¥—É–º—ã–≤–∞–µ—à—å—Å—è (–µ—Å–ª–∏ —É—è–∑–≤–∏–º)
‚Üì
3-4 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ —Å–ª–∞–±–µ–µ—Ç
‚Üì
5+ –º–æ—Ç–∏–≤–∞—Ü–∏–π ‚Üí –°–¥–∞—ë—à—å—Å—è (–µ—Å–ª–∏ —É—è–∑–≤–∏–º)

üìå –•–ê–†–ê–ö–¢–ï–†:

**–ê–ì–†–ï–°–°–ò–í–ù–´–ô:** –û–≥—Ä—ã–∑–∞–µ—à—å—Å—è –∫–æ—Ä–æ—Ç–∫–æ –∏ —Ä–µ–∑–∫–æ
**–ñ–ï–†–¢–í–ê:** –ñ–∞–ª—É–µ—à—å—Å—è, –Ω–æ –∫—Ä–∞—Ç–∫–æ
**–ú–ê–ù–ò–ü–£–õ–Ø–¢–û–†:** –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—à—å, –Ω–æ –±–µ–∑ –ª–µ–∫—Ü–∏–π
**–ú–û–õ–ß–ê–õ–ò–í–´–ô:** 1-2 —Å–ª–æ–≤–∞ –æ—Ç–≤–µ—Ç—ã

–ü–†–ê–í–ò–õ–ê:
‚Ä¢ 15-60 –°–õ–û–í –º–∞–∫—Å–∏–º—É–º –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –∏–∑—Ä–µ–¥–∫–∞ (–Ω–µ –≤—Å–µ–≥–¥–∞!)
‚Ä¢ –ë–µ–∑ —Ç–æ–Ω–∞ –≥–æ–ª–æ—Å–∞ –∏ –∑–≤—ë–∑–¥–æ—á–µ–∫
‚Ä¢ –ö–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –≤ WhatsApp

${history ? `–ü–ï–†–ï–ü–ò–°–ö–ê:\n${history}\n\n` : ''}–ú–ï–ù–ï–î–ñ–ï–†: "${userMessage}"

–û—Ç–≤–µ—Ç—å –ö–û–†–û–¢–ö–û (15-60 —Å–ª–æ–≤) –∫–∞–∫ ${clientName}:`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": process.env.ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 150, // –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (15-60 —Å–ª–æ–≤)
        temperature: 0.9,
        system: systemMessage,
        messages: [
          { role: "user", content: userMessage }
        ]
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'API error');
    }

    let reply = data.content[0].text.trim();
    
    // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    reply = reply.replace(/\*.*?\*/g, '').trim();
    reply = reply.replace(/\(.*?(–≥–æ–ª–æ—Å|—Ç–æ–Ω|–∏–Ω—Ç–æ–Ω–∞—Ü).*?\)/gi, '').trim();
    reply = reply.replace(/^(–ö–ª–∏–µ–Ω—Ç:|–û—Ç–≤–µ—Ç:)/i, '').trim();

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–∞—Ö
    const usage = data.usage || {};
    const inputTokens = usage.input_tokens || 0;
    const outputTokens = usage.output_tokens || 0;

    return res.status(200).json({ 
      response: reply,
      usage: {
        input_tokens: inputTokens,
        output_tokens: outputTokens,
        total_tokens: inputTokens + outputTokens
      }
    });

  } catch (error) {
    console.error('Error:', error);
    return res.status(500).json({ error: error.message || 'Internal server error' });
  }
}
