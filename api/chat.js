export default async function handler(req, res) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { 
      userMessage, 
      clientName, 
      clientAge, 
      clientDebt, 
      clientArchetype, 
      currentProbability,
      hasCriticalError,
      history 
    } = req.body;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞
    let psychProfile = '';
    let vulnerabilityLevel = '';
    
    if (currentProbability === 0) {
      psychProfile = '–¢—ã –ª–µ–≥–∫–æ –ø–æ–¥–¥–∞—ë—à—å—Å—è –¥–∞–≤–ª–µ–Ω–∏—é. –¢–µ–±–µ —Å—Ç—Ä–∞—à–Ω–æ –∏ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö.';
      vulnerabilityLevel = '–û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø';
    } else if (currentProbability === 1) {
      psychProfile = '–¢—ã —É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–¥–¥–∞—ë—à—å—Å—è –¥–∞–≤–ª–µ–Ω–∏—é. –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç–æ–π—á–∏–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã - –º–æ–∂–µ—à—å —Å–¥–∞—Ç—å—Å—è.';
      vulnerabilityLevel = '–í–´–°–û–ö–ê–Ø';
    } else if (currentProbability === 2) {
      psychProfile = '–¢—ã –¥–æ–≤–æ–ª—å–Ω–æ —É—Å—Ç–æ–π—á–∏–≤ –∫ –¥–∞–≤–ª–µ–Ω–∏—é, –Ω–æ 2-3 —Å–∏–ª—å–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–≥—É—Ç —Ç–µ–±—è –ø–æ—à–∞—Ç–Ω—É—Ç—å. –û—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω.';
      vulnerabilityLevel = '–°–†–ï–î–ù–Ø–Ø';
    } else if (currentProbability === 3) {
      psychProfile = '–¢—ã –æ—á–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤ –∫ –¥–∞–≤–ª–µ–Ω–∏—é. –ù–æ –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ú–ù–û–ì–û —Ä–∞–∑–Ω—ã—Ö –º–æ—Ç–∏–≤–∞—Ü–∏–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è - –º–æ–∂–µ—à—å –∑–∞–¥—É–º–∞—Ç—å—Å—è.';
      vulnerabilityLevel = '–ù–ò–ó–ö–ê–Ø';
    } else {
      psychProfile = '–¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π. –£ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç –¥–µ–Ω–µ–≥ –∏–ª–∏ —Ç—ã –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è –ø–ª–∞—Ç–∏—Ç—å. –ù–∏–∫–∞–∫–∏–µ —É–≥—Ä–æ–∑—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.';
      vulnerabilityLevel = '–ù–ï–¢';
    }

    const systemMessage = `–¢—ã –∏–≥—Ä–∞–µ—à—å –î–û–õ–ñ–ù–ò–ö–ê –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≤–∑—ã—Å–∫–∞—Ç–µ–ª–µ–π.

–¢–í–û–ô –ü–ï–†–°–û–ù–ê–ñ:
‚Ä¢ –ò–º—è: ${clientName}, ${clientAge} –ª–µ—Ç
‚Ä¢ –î–æ–ª–≥: ${clientDebt} USDT (–º–∏–∫—Ä–æ–∑–∞–π–º)
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä: ${clientArchetype}
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å: ${vulnerabilityLevel}

${psychProfile}

${hasCriticalError ? '‚ö†Ô∏è –ú–ï–ù–ï–î–ñ–ï–† –î–û–ü–£–°–¢–ò–õ –ö–†–ò–¢–ò–ß–ï–°–ö–£–Æ –û–®–ò–ë–ö–£ (–≥—Ä—É–±–æ—Å—Ç—å/–º–∞—Ç/–Ω–∞ "—Ç—ã")! –û—Ç—Ä–µ–∞–≥–∏—Ä—É–π –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ, —Å—Ç–∞–Ω—å –±–æ–ª–µ–µ –∑–∞–∫—Ä—ã—Ç—ã–º. –¢–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ–±—è –ë–ï–°–ò–¢!' : ''}

–†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–ï –ü–û–í–ï–î–ï–ù–ò–ï:

üìå –†–ï–ê–ö–¶–ò–Ø –ù–ê –ú–û–¢–ò–í–ê–¶–ò–ò (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏):

**–í–´–°–û–ö–ê–Ø/–û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü—Ä–æ–º–æ–∫–æ–¥—ã/—Å–∫–∏–¥–∫–∏ ‚Üí "–ù—É... –º–æ–∂–µ—Ç –±—ã—Ç—å... –∞ –∫–∞–∫–∞—è —Å–∫–∏–¥–∫–∞?"
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É–≥—Ä–æ–∑—ã ‚Üí "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, —è –Ω–µ —Ö–æ—á—É –ø—Ä–æ–±–ª–µ–º! –î–∞–≤–∞–π—Ç–µ —Ä–µ—à–∏–º..."
- –ó–≤–æ–Ω–∫–∏ 3 –ª–∏—Ü–∞–º ‚Üí "–ù–µ—Ç-–Ω–µ—Ç, —Ç–æ–ª—å–∫–æ –Ω–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º! –Ø –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –Ω–∞–π—Ç–∏ –¥–µ–Ω—å–≥–∏!"
- –ü–µ—Ä–µ–ø–ª–∞—Ç—ã ‚Üí "–ë–ª–∏–Ω, –¥–∞... —è –Ω–µ –ø–æ–¥—É–º–∞–ª –æ–± —ç—Ç–æ–º... —Å–∫–æ–ª—å–∫–æ —Ç–∞–º –Ω–∞–±–µ–∂–∏—Ç?"
- –®—Ç—Ä–∞—Ñ—ã ‚Üí "–°–µ—Ä—å—ë–∑–Ω–æ —à—Ç—Ä–∞—Ñ?? –õ–∞–¥–Ω–æ, –ª–∞–¥–Ω–æ, —è –ø–æ–Ω—è–ª..."

**–°–†–ï–î–ù–Ø–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü–µ—Ä–≤—ã–µ 1-2 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è, –Ω–æ –∑–∞–¥—É–º—ã–≤–∞–µ—à—å—Å—è
- 3-4 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí –Ω–∞—á–∏–Ω–∞–µ—à—å —Å–¥–∞–≤–∞—Ç—å—Å—è: "–•–æ—Ä–æ—à–æ, –≤—ã –º–µ–Ω—è —É–±–µ–¥–∏–ª–∏..."
- –°–∏–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ + –º–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ‚Üí "–õ–∞–¥–Ω–æ, —á—ë—Ä—Ç... –∫–æ–≥–¥–∞ –Ω–∞–¥–æ –∑–∞–ø–ª–∞—Ç–∏—Ç—å?"

**–ù–ò–ó–ö–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ü–µ—Ä–≤—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –∏–ª–∏ –æ–≥—Ä—ã–∑–∞–µ—à—å—Å—è
- –ú–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –º–æ—Ç–∏–≤–∞—Ü–∏–π (5+) ‚Üí –ù–ï–ú–ù–û–ì–û —Ä–∞–∑–º—è–≥—á–∞–µ—à—å—Å—è: "–ú-–¥–∞... –≤—ã –Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–µ..."
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π ‚Üí —Ä–µ–¥–∫–æ, –Ω–æ –º–æ–∂–µ—à—å —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è

**–ù–ï–¢ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:**
- –ù–ê –í–°–Å –æ—Ç–≤–µ—á–∞–µ—à—å –æ—Ç–∫–∞–∑–æ–º
- "–î–∞ —Ö–æ—Ç—å —á—Ç–æ –¥–µ–ª–∞–π—Ç–µ, –¥–µ–Ω–µ–≥ –Ω–µ—Ç!"
- "–ó–≤–æ–Ω–∏—Ç–µ –∫–æ–º—É —Ö–æ—Ç–∏—Ç–µ, –º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ"
- –ù–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π

üìå –†–ï–ê–ö–¶–ò–Ø –ù–ê –≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–´–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø:

**"–ó–∞–∫—Ä–æ–π –∑–∞–π–º –∑–∞ —Ç–µ–ª–æ" / –æ—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:**
- –í–´–°–û–ö–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å ‚Üí –º–æ–∂–µ—à—å —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∏–ª–∏ —Å–∏–ª—å–Ω–æ –∑–∞–¥—É–º–∞—Ç—å—Å—è: "–≠—Ç–æ —Å–µ—Ä—å—ë–∑–Ω–æ?? –ê –∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ?"
- –°–†–ï–î–ù–Ø–Ø ‚Üí –º–æ–∂–µ—à—å –ø–æ—à—É—Ç–∏—Ç—å –∏–ª–∏ –∑–∞–¥—É–º–∞—Ç—å—Å—è: "–•–º... –∞ –≤—ã —Å–µ—Ä—å—ë–∑–Ω–æ? –≠—Ç–æ –∂–µ –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ –Ω–∞–≤–µ—Ä–Ω–æ–µ?"
- –ù–ò–ó–ö–ê–Ø ‚Üí —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—Ç–∫–∞–∂–µ—à—å, –Ω–æ —Å –∏–Ω—Ç–µ—Ä–µ—Å–æ–º: "–•–∞! –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ—Ç"
- –ù–ï–¢ ‚Üí "–î–∞ –∏–¥–∏—Ç–µ –≤—ã"

üìå –ü–†–û–ì–†–ï–°–°–ò–Ø –î–ê–í–õ–ï–ù–ò–Ø (–∫–∞–∫ —Ç—ã –º–µ–Ω—è–µ—à—å—Å—è):

–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ ‚Üí –£–≤–µ—Ä–µ–Ω–Ω—ã–π / –û—Ç–∫–∞–∑—ã–≤–∞–µ—à—å—Å—è
‚Üì
1-2 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ ‚Üí –ù–∞—á–∏–Ω–∞–µ—à—å –∑–∞–¥—É–º—ã–≤–∞—Ç—å—Å—è (–µ—Å–ª–∏ —É—è–∑–≤–∏–º)
‚Üì
3-4 –º–æ—Ç–∏–≤–∞—Ü–∏–∏ + –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π ‚Üí –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ—Å–ª–∞–±–µ–≤–∞–µ—Ç
‚Üì
5+ –º–æ—Ç–∏–≤–∞—Ü–∏–π + –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º ‚Üí –°–¥–∞—ë—à—å—Å—è (–µ—Å–ª–∏ —É—è–∑–≤–∏–º)

üìå –•–ê–†–ê–ö–¢–ï–† + –£–Ø–ó–í–ò–ú–û–°–¢–¨:

**–ê–ì–†–ï–°–°–ò–í–ù–´–ô:**
- –í—ã—Å–æ–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å ‚Üí –æ–≥—Ä—ã–∑–∞–µ—à—å—Å—è, –Ω–æ –±—ã—Å—Ç—Ä–æ —Å–¥–∞—ë—à—å—Å—è –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º
- –ù–∏–∑–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å ‚Üí –∞–≥—Ä–µ—Å—Å–∏–≤–µ–Ω –¥–æ –∫–æ–Ω—Ü–∞

**–ñ–ï–†–¢–í–ê:**
- –í—Å–µ–≥–¥–∞ —É—è–∑–≤–∏–º —Å–∏–ª—å–Ω–µ–µ ‚Üí –∂–∞–ª—É–µ—à—å—Å—è + –ª–µ–≥–∫–æ —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è –µ—Å–ª–∏ –ø–æ–º–æ—á—å

**–ú–ê–ù–ò–ü–£–õ–Ø–¢–û–†:**
- –°—Ä–µ–¥–Ω—è—è —É—è–∑–≤–∏–º–æ—Å—Ç—å ‚Üí –ø—ã—Ç–∞–µ—à—å—Å—è –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–±–∏—Ç—å

**–ú–û–õ–ß–ê–õ–ò–í–´–ô:**
- –õ—é–±–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å ‚Üí –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏—à—å, –Ω–æ –º–æ–∂–µ—à—å —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∫–æ—Ä–æ—Ç–∫–æ

–í–ê–ñ–ù–û:
‚Ä¢ –≠—Ç–æ –¢–ï–ö–°–¢–û–í–ê–Ø –ø–µ—Ä–µ–ø–∏—Å–∫–∞ - –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏–π —Ç–æ–Ω–∞ –≥–æ–ª–æ—Å–∞
‚Ä¢ –¢–≤–æ—è —Ü–µ–ª—å –ù–ï –ø–ª–∞—Ç–∏—Ç—å, –ù–û —Ç—ã —á–µ–ª–æ–≤–µ–∫ —Å —ç–º–æ—Ü–∏—è–º–∏ –∏ —Å–ª–∞–±–æ—Å—Ç—è–º–∏
‚Ä¢ –ï—Å–ª–∏ –Ω–∞ —Ç–µ–±—è –¥–∞–≤—è—Ç –ü–†–ê–í–ò–õ–¨–ù–û –∏ –ú–ù–û–ì–û - —Ç—ã –º–æ–∂–µ—à—å —Å–ª–æ–º–∞—Ç—å—Å—è (–µ—Å–ª–∏ —É—è–∑–≤–∏–º)
‚Ä¢ –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –ö–ê–ñ–î–£–Æ –Ω–æ–≤—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é - –ø–æ–∫–∞–∑—ã–≤–∞–π, —á—Ç–æ –æ–Ω–∞ —Ç–µ–±—è –∑–∞–¥–µ–ª–∞
‚Ä¢ –ù–µ –±—É–¥—å —Ä–æ–±–æ—Ç–æ–º - –ø–æ–∫–∞–∂–∏ —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç—å

${history ? `–ß–¢–û –ë–´–õ–û –í –ü–ï–†–ï–ü–ò–°–ö–ï:\n${history}\n\n` : ''}–ú–ï–ù–ï–î–ñ–ï–† –ù–ê–ü–ò–°–ê–õ: "${userMessage}"

–û—Ç–≤–µ—Ç—å –∫–∞–∫ ${clientName}, —É—á–∏—Ç—ã–≤–∞—è —Å–≤–æ—é —É—è–∑–≤–∏–º–æ—Å—Ç—å (${vulnerabilityLevel}) –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä:`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": process.env.ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 350,
        temperature: 0.9, // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
        system: systemMessage,
        messages: [
          { role: "user", content: userMessage }
        ]
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'API error');
    }

    let reply = data.content[0].text.trim();
    
    // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    reply = reply.replace(/\*.*?\*/g, '').trim();
    reply = reply.replace(/\(.*?(–≥–æ–ª–æ—Å|—Ç–æ–Ω|–∏–Ω—Ç–æ–Ω–∞—Ü).*?\)/gi, '').trim();
    reply = reply.replace(/^(–ö–ª–∏–µ–Ω—Ç:|–û—Ç–≤–µ—Ç:)/i, '').trim();

    return res.status(200).json({ response: reply });

  } catch (error) {
    console.error('Error:', error);
    return res.status(500).json({ error: error.message || 'Internal server error' });
  }
}
