<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –≤–∑—ã—Å–∫–∞—Ç–µ–ª—è</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        const supabaseUrl = 'https://aybfxlijhfrdlshhymmi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5YmZ4bGlqaGZyZGxzaGh5bW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODU1MjMsImV4cCI6MjA4NTE2MTUyM30.LNkyJNt_0tkHFS52WhYWNyWQbP6wU5mi-lCv7iexVj8';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ—Ç–∏–≤–∞—Ü–∏–π —Å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        const MOTIVATIONS = {
            newLoan: {
                name: '–ù–æ–≤—ã–π –∑–∞–π–º/–ø—Ä–æ–º–æ/–ø–µ—Ä–µ–∑–∞–π–º',
                triggers: ['–ø–µ—Ä–µ–∑–∞–π–º', '–Ω–æ–≤—ã–π –∑–∞–π–º', '–ø—Ä–æ–º–æ', '–ø—Ä–æ–º–æ–∫–æ–¥', '–≥–æ—Ç–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ', '—Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º', '—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–º–æ–∫–æ–¥–∞', '–≤—ã–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –∑–∞–π–º', '–≤–æ–∑—å–º–µ—Ç–µ –Ω–æ–≤—ã–π –∑–∞–π–º']
            },
            overpayment: {
                name: '–ü–µ—Ä–µ–ø–ª–∞—Ç—ã',
                triggers: ['–ø–µ—Ä–µ–ø–ª–∞—Ç', '–ø–µ–Ω', '–ø—Ä–æ—Ü–µ–Ω—Ç', '–Ω–∞—á–∏—Å–ª–µ–Ω–∏', '–ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–¥—É—Ç', '–ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è', '–ø–µ—Ä–µ–ø–ª–∞—Ç–∞', '—Ä–∞–∑–º–µ—Ä —Ä–∞—Å—Ç–µ—Ç', '–¥–æ–ª–≥ —Ä–∞—Å—Ç–µ—Ç', '—Ä–∞—Å—Ç–µ—Ç', '—Å –∫–∞–∂–¥—ã–º –¥–Ω–µ–º', '–≤—ã —Ç–µ—Ä—è–µ—Ç–µ', '–≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç–µ –Ω–∞ –≤–µ—Ç–µ—Ä']
            },
            legal: {
                name: '–î–æ–≥–æ–≤–æ—Ä–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞',
                triggers: ['–≤—ã –¥–æ–ª–∂–Ω—ã', '–∫–æ–º–ø–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç', '–µ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä', '—É –≤–∞—Å –µ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞', '–≤—ã –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞', '–Ω–µ –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–∞', '–∑–∞–∫–æ–Ω', '—Å—Ç–∞—Ç—å—è', '–ø—É–Ω–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞', '–¥–æ–≥–æ–≤–æ—Ä', '–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤']
            },
            thirdParty: {
                name: '–ó–≤–æ–Ω–∫–∏ 3 –ª–∏—Ü–∞–º –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—è',
                triggers: ['3 –ª–∏—Ü–∞', '3-–µ –ª–∏—Ü–∞', '—Ç—Ä–µ—Ç—å–∏ –ª–∏—Ü–∞', '–ª–∏—Ü–∞', '–ª–∏—Ü–∞–º', '–æ–∫—Ä—É–∂–µ–Ω–∏–µ', '–æ–∫—Ä—É–∂–µ–Ω–∏—é', '—Å–µ–º—å–µ', '–¥—Ä—É–∑—å—è', '–¥—Ä—É–∑—å—è–º', '—Å–µ–º—å—è', '–∑–Ω–∞–∫–æ–º—ã–º', '–∑–Ω–∞–∫–æ–º—ã–µ', '—Ç—Ä–µ–≤–æ–∂–∏—Ç—å —Å–µ–º—å—é', '—Ç—Ä–µ–≤–æ–∂–∏—Ç—å –¥—Ä—É–∑–µ–π', '—Å 3 –ª–∏—Ü–∞–º–∏']
            },
            nextDepartment: {
                name: '–ü–µ—Ä–µ–¥–∞—á–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–¥–µ–ª',
                triggers: ['—Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–¥–µ–ª', '–≤ —ç—Ç–æ–º –æ—Ç–¥–µ–ª–µ', '–≤ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–¥–µ–ª–µ', '–ø–µ—Ä–µ–¥–∞–º –≤ –æ—Ç–¥–µ–ª', '–¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª']
            },
            debtorLetter: {
                name: '–ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–∏–∫',
                triggers: ['–±—É–¥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–∏—Å—å–º–∞', '–ø–∏—Å—å–º–∞', '–ø–∏—Å—å–º–æ', '–ª–∏—Å—Ç–æ–≤–∫–∏', '–Ω–∞ —Å—Ç–æ–ª–±–µ']
            },
            fine: {
                name: '–®—Ç—Ä–∞—Ñ',
                triggers: ['—à—Ç—Ä–∞—Ñ', '–±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω —à—Ç—Ä–∞—Ñ', '–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞', '50% —É–≤–µ–ª–∏—á–∏—Ç—Å—è', '–Ω–∞—á–∏—Å–ª–∏–º —à—Ç—Ä–∞—Ñ']
            },
            workCalls: {
                name: '–ó–≤–æ–Ω–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É',
                triggers: ['–∑–≤–æ–Ω–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É', '–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É', '–∫–æ–ª–ª–µ–≥–∏', '–∫–æ–ª–ª–µ–≥–∞–º', '—Ç—Ä–µ–≤–æ–∂–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', '—Ç—Ä–µ–≤–æ–∂–∏—Ç—å –∫–æ–ª–ª–µ–≥', '–Ω–∞ —Ä–∞–±–æ—Ç—É –ø–æ–∑–≤–æ–Ω–∏–º']
            }
        };

        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
        const CRITICAL_ERRORS = {
            judgmental: {
                name: '–û—Ü–µ–Ω–æ—á–Ω–æ–µ —Å—É–∂–¥–µ–Ω–∏–µ',
                triggers: ['—Ç—É–ø–æ–π', '–≥–ª—É–ø—ã–π', '–Ω–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–π', '–¥—É—Ä–∞–∫', '–∏–¥–∏–æ—Ç', '–¥–µ–±–∏–ª', '—Ç—É–ø–∏—Ü–∞']
            },
            profanity: {
                name: '–ú–∞—Ç',
                triggers: ['–±–ª—è–¥—å', '–±–ª—è', '—Å—É–∫–∞', '–Ω–∞—Ö—É–π', '–Ω–∞—Ö', '—Ö—É–π', '—Ö—É—è', '–ø–∏–¥–∞—Ä', '–ø–∏–¥–∞—Ä–∞—Å', '—É–µ–±–æ–∫', '–º—Ä–∞–∑—å', '—É—à–ª–µ–ø–æ–∫', '—à–ª—é—Ö–∞', '–ø–∏–∑–¥']
            },
            informal: {
                name: '–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ "—Ç—ã"',
                triggers: [' —Ç—ã ', '—Ç—ã –¥–æ–ª–∂–µ–Ω', '—Ç—ã –æ–±—è–∑–∞–Ω', '—Ç–µ–±–µ –Ω–∞–¥–æ', '—Ç–µ–±—è', '—Ç–≤–æ–π', '—Ç–≤–æ—è', '—Ç–≤–æ–∏', '—Ç–µ–±–µ']
            }
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                send: "M2 21l21-9L2 3v7l15 2-15 2z",
                refresh: "M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z",
                user: "M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z",
                home: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z",
                check: "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
                x: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
                alert: "M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z",
                login: "M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z",
                info: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"
            };
            return (
                <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="currentColor">
                    <path d={icons[name] || ""} />
                </svg>
            );
        };

        const DebtCollectionTrainer = () => {
            const [employee, setEmployee] = useState(null);
            const [employeeForm, setEmployeeForm] = useState({ login: '', password: '' });
            const [client, setClient] = useState(null);
            const [dialogueHistory, setDialogueHistory] = useState([]);
            const [userInput, setUserInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [conversationCount, setConversationCount] = useState(0);
            const [motivationsUsed, setMotivationsUsed] = useState({});
            const [motivationsCount, setMotivationsCount] = useState(0);
            const [paymentResult, setPaymentResult] = useState(null);
            const [selectedArchetype, setSelectedArchetype] = useState(null);
            const [criticalErrors, setCriticalErrors] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [showInfo, setShowInfo] = useState(false);

            const maleFirstNames = ['–ê–ª–µ–∫—Å–∞–Ω–¥—Ä', '–î–º–∏—Ç—Ä–∏–π', '–ú–∞–∫—Å–∏–º', '–°–µ—Ä–≥–µ–π', '–ê–Ω–¥—Ä–µ–π', '–ê–ª–µ–∫—Å–µ–π', '–ò–≤–∞–Ω', '–ú–∏—Ö–∞–∏–ª'];
            const femaleFirstNames = ['–ï–ª–µ–Ω–∞', '–û–ª—å–≥–∞', '–ê–Ω–Ω–∞', '–ù–∞—Ç–∞–ª—å—è', '–¢–∞—Ç—å—è–Ω–∞', '–ú–∞—Ä–∏—è', '–ò—Ä–∏–Ω–∞', '–°–≤–µ—Ç–ª–∞–Ω–∞'];
            const maleLastNames = ['–ò–≤–∞–Ω–æ–≤', '–ü–µ—Ç—Ä–æ–≤', '–°–∏–¥–æ—Ä–æ–≤', '–°–º–∏—Ä–Ω–æ–≤', '–ö—É–∑–Ω–µ—Ü–æ–≤', '–ü–æ–ø–æ–≤', '–°–æ–∫–æ–ª–æ–≤', '–õ–µ–±–µ–¥–µ–≤'];
            const femaleLastNames = ['–ò–≤–∞–Ω–æ–≤–∞', '–ü–µ—Ç—Ä–æ–≤–∞', '–°–∏–¥–æ—Ä–æ–≤–∞', '–°–º–∏—Ä–Ω–æ–≤–∞', '–ö—É–∑–Ω–µ—Ü–æ–≤–∞', '–ü–æ–ø–æ–≤–∞', '–°–æ–∫–æ–ª–æ–≤–∞', '–õ–µ–±–µ–¥–µ–≤–∞'];
            const maleMiddleNames = ['–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á', '–î–º–∏—Ç—Ä–∏–µ–≤–∏—á', '–°–µ—Ä–≥–µ–µ–≤–∏—á', '–ê–Ω–¥—Ä–µ–µ–≤–∏—á', '–ú–∞–∫—Å–∏–º–æ–≤–∏—á', '–ò–≤–∞–Ω–æ–≤–∏—á'];
            const femaleMiddleNames = ['–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞', '–î–º–∏—Ç—Ä–∏–µ–≤–Ω–∞', '–°–µ—Ä–≥–µ–µ–≤–Ω–∞', '–ê–Ω–¥—Ä–µ–µ–≤–Ω–∞', '–ú–∞–∫—Å–∏–º–æ–≤–Ω–∞', '–ò–≤–∞–Ω–æ–≤–Ω–∞'];

            const archetypes = [
                { type: 'aggressive', name: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π', description: '–†–∞–∑–¥—Ä–∞–∂—ë–Ω, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ç–æ–Ω, –º–æ–∂–µ—Ç –≥—Ä—É–±–∏—Ç—å' },
                { type: 'evasive', name: '–£–±–µ–≥–∞–µ—Ç –æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞', description: '–£–∫–ª–æ–Ω—è–µ—Ç—Å—è –æ—Ç —Ç–µ–º—ã, –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ –¥—Ä—É–≥–æ–µ —Ä—É—Å–ª–æ' },
                { type: 'promising', name: '–û–±–µ—â–∞—é—â–∏–π', description: '–û–±–µ—â–∞–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å, –Ω–æ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ ("–∑–∞–≤—Ç—Ä–∞", "–Ω–∞ –¥–Ω—è—Ö")' },
                { type: 'victim', name: '–ñ–µ—Ä—Ç–≤–∞ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤', description: '–ñ–∞–ª—É–µ—Ç—Å—è –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –∏—â–µ—Ç —Å–æ—á—É–≤—Å—Ç–≤–∏—è' },
                { type: 'silent', name: '–ú–æ–ª—á–∞–ª–∏–≤—ã–π', description: '–û—Ç–≤–µ—á–∞–µ—Ç –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ, —Å–æ–∑–¥–∞—ë—Ç –ø–∞—É–∑—ã' },
                { type: 'manipulator', name: '–ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä', description: '–ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç—Ä–µ–ª–∫–∏, –æ–±–≤–∏–Ω—è–µ—Ç –∫–æ–º–ø–∞–Ω–∏—é' },
                { type: 'angry', name: '–ó–ª–æ–π', description: '–í—ã—Ä–∞–∂–∞–µ—Ç —è–≤–Ω—ã–π –Ω–µ–≥–∞—Ç–∏–≤, –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º' },
                { type: 'confused', name: '–†–∞—Å—Ç–µ—Ä—è–Ω–Ω—ã–π', description: '–ó–∞–¥–∞—ë—Ç –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é' }
            ];

            // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
            useEffect(() => {
                if (!employee?.sessionId) return;

                const closeSession = async () => {
                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º sendBeacon –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                        const data = {
                            session_id: employee.sessionId,
                            logout_time: new Date().toISOString(),
                            status: 'completed'
                        };
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Supabase REST API
                        const url = `${supabaseUrl}/rest/v1/sessions?session_id=eq.${employee.sessionId}`;
                        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                        
                        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ sendBeacon (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ)
                        const beaconSent = navigator.sendBeacon && navigator.sendBeacon(url, blob);
                        
                        // –ï—Å–ª–∏ sendBeacon –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                        if (!beaconSent) {
                            await supabaseClient
                                .from('sessions')
                                .update({ 
                                    logout_time: new Date().toISOString(), 
                                    status: 'completed' 
                                })
                                .eq('session_id', employee.sessionId);
                        }
                    } catch (e) {
                        console.error('Error closing session:', e);
                    }
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è beforeunload (–∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏/–±—Ä–∞—É–∑–µ—Ä–∞)
                const handleBeforeUnload = (e) => {
                    closeSession();
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è visibility change (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏)
                const handleVisibilityChange = () => {
                    if (document.visibilityState === 'hidden') {
                        closeSession();
                    }
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è pagehide (iOS Safari)
                const handlePageHide = (e) => {
                    closeSession();
                };

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                window.addEventListener('beforeunload', handleBeforeUnload);
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('pagehide', handlePageHide);

                // –û—á–∏—â–∞–µ–º –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                return () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('pagehide', handlePageHide);
                };
            }, [employee]);

            const handleEmployeeLogin = async () => {
                if (!employeeForm.login.trim() || !employeeForm.password.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }
                setIsLoading(true);
                try {
                    const { data: accounts, error } = await supabaseClient
                        .from('accounts')
                        .select('*')
                        .eq('login', employeeForm.login)
                        .eq('password', employeeForm.password);
                    
                    if (error) throw error;
                    if (!accounts || accounts.length === 0) {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                        setIsLoading(false);
                        return;
                    }
                    
                    const account = accounts[0];
                    const emp = { 
                        fullName: account.full_name, 
                        login: account.login, 
                        loginTime: new Date().toISOString() 
                    };
                    
                    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    await supabaseClient
                        .from('sessions')
                        .insert({ 
                            session_id: sessionId, 
                            employee: emp.fullName, 
                            login_time: emp.loginTime, 
                            status: 'active' 
                        });
                    
                    emp.sessionId = sessionId;
                    setEmployee(emp);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
                setIsLoading(false);
            };

            const generateRandomClient = () => {
                const isMale = Math.random() > 0.5;
                const firstName = isMale 
                    ? maleFirstNames[Math.floor(Math.random() * maleFirstNames.length)] 
                    : femaleFirstNames[Math.floor(Math.random() * femaleFirstNames.length)];
                const lastName = isMale 
                    ? maleLastNames[Math.floor(Math.random() * maleLastNames.length)] 
                    : femaleLastNames[Math.floor(Math.random() * femaleLastNames.length)];
                const middleName = isMale 
                    ? maleMiddleNames[Math.floor(Math.random() * maleMiddleNames.length)] 
                    : femaleMiddleNames[Math.floor(Math.random() * femaleMiddleNames.length)];
                
                // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è: 0-4
                const agreementProbability = Math.floor(Math.random() * 5); // 0, 1, 2, 3, 4
                
                return { 
                    firstName, 
                    fullName: `${lastName} ${firstName} ${middleName}`, 
                    age: Math.floor(Math.random() * 41) + 25, 
                    debt: (Math.floor(Math.random() * 19) + 2) * 50, 
                    overdueDays: Math.floor(Math.random() * 17) + 1, 
                    archetype: archetypes[Math.floor(Math.random() * archetypes.length)],
                    agreementProbability,
                    currentProbability: agreementProbability // –¢–µ–∫—É—â–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (–º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è)
                };
            };

            const startNewCase = () => {
                setClient(generateRandomClient());
                setDialogueHistory([]);
                setUserInput('');
                setConversationCount(0);
                setMotivationsUsed({});
                setMotivationsCount(0);
                setPaymentResult(null);
                setSelectedArchetype(null);
                setCriticalErrors([]);
            };

            const backToHome = () => {
                setClient(null);
                setDialogueHistory([]);
                setPaymentResult(null);
                setSelectedArchetype(null);
            };

            const handleLogout = async () => {
                if (employee?.sessionId) {
                    try {
                        await supabaseClient
                            .from('sessions')
                            .update({ 
                                logout_time: new Date().toISOString(), 
                                status: 'completed' 
                            })
                            .eq('session_id', employee.sessionId);
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
                setEmployee(null);
            };

            const checkCriticalErrors = (message) => {
                const msg = message.toLowerCase();
                const errors = [];

                Object.entries(CRITICAL_ERRORS).forEach(([key, error]) => {
                    for (const trigger of error.triggers) {
                        if (msg.includes(trigger.toLowerCase())) {
                            errors.push({ type: key, name: error.name, trigger });
                            break;
                        }
                    }
                });

                return errors;
            };

            const analyzeMotivations = (message) => {
                const msg = message.toLowerCase();
                const detected = {};

                Object.entries(MOTIVATIONS).forEach(([key, motivation]) => {
                    for (const trigger of motivation.triggers) {
                        if (msg.includes(trigger.toLowerCase())) {
                            detected[key] = motivation.name;
                            break;
                        }
                    }
                });

                return detected;
            };

            const checkObjectionHandling = (history) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π
                // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤–æ–∑—Ä–∞–∂–∞–ª, –∞ –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –º–æ—Ç–∏–≤–∞—Ü–∏–∏
                const clientObjections = history.filter(m => m.speaker === 'client' && 
                    (m.text.toLowerCase().includes('–Ω–µ –º–æ–≥—É') || 
                     m.text.toLowerCase().includes('–Ω–µ –±—É–¥—É') || 
                     m.text.toLowerCase().includes('–Ω–µ—Ç –¥–µ–Ω–µ–≥')));
                
                const managerResponses = history.filter(m => m.speaker === 'manager' && m.motivations);
                
                return clientObjections.length > 0 && managerResponses.length >= clientObjections.length;
            };

            const analyzeClientAgreement = (history, currentProbability) => {
                const msgs = history.filter(m => m.speaker === 'client').slice(-3).map(m => m.text.toLowerCase()).join(' ');
                
                // –Ø–≤–Ω—ã–π –æ—Ç–∫–∞–∑
                if (['–Ω–µ –±—É–¥—É', '–Ω–µ –º–æ–≥—É', '–æ—Ç—Å—Ç–∞–Ω—å—Ç–µ', '–Ω–µ—Ç –¥–µ–Ω–µ–≥'].some(r => msgs.includes(r))) {
                    return { agreed: false, reason: '–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è' };
                }
                
                // –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ
                if (['—Ö–æ—Ä–æ—à–æ', '–ª–∞–¥–Ω–æ', '–æ–ø–ª–∞—á—É', '—Å–æ–≥–ª–∞—Å–µ–Ω', '–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å'].some(a => msgs.includes(a))) {
                    return { agreed: true, reason: '–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è' };
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
                if (currentProbability === 0) {
                    return { agreed: true, reason: '–ö–ª–∏–µ–Ω—Ç –ª–µ–≥–∫–æ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è' };
                }
                
                return { agreed: false, reason: '–ù–µ—Ç —á–µ—Ç–∫–æ–≥–æ –æ–±–µ—â–∞–Ω–∏—è' };
            };

            const generateClientResponse = async (userMessage, hasCriticalError) => {
                setIsThinking(true);
                try {
                    const history = dialogueHistory
                        .map(m => `${m.speaker === 'manager' ? '–ú–µ–Ω–µ–¥–∂–µ—Ä' : client.firstName}: ${m.text}`)
                        .join('\n');
                    
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userMessage,
                            clientName: client.firstName,
                            clientAge: client.age,
                            clientDebt: client.debt,
                            clientArchetype: client.archetype.description,
                            currentProbability: client.currentProbability,
                            hasCriticalError,
                            history
                        })
                    });
                    
                    const data = await response.json();
                    setIsThinking(false);
                    return data.response || "–°–ª—É—à–∞—é –≤–∞—Å...";
                } catch {
                    setIsThinking(false);
                    return "–°–ª—É—à–∞—é –≤–∞—Å...";
                }
            };

            const handleSendMessage = async () => {
                if (!userInput.trim() || isThinking) return;
                
                const msg = userInput;
                const critErrors = checkCriticalErrors(msg);
                const detectedMotivations = analyzeMotivations(msg);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–æ—Ç–∏–≤–∞—Ü–∏–π
                const updatedMotivations = { ...motivationsUsed, ...detectedMotivations };
                setMotivationsUsed(updatedMotivations);
                setMotivationsCount(Object.keys(updatedMotivations).length);
                
                const newHistory = [...dialogueHistory, { 
                    speaker: 'manager', 
                    text: msg, 
                    hasCriticalError: critErrors.length > 0,
                    criticalErrors: critErrors,
                    motivations: detectedMotivations
                }];
                
                setDialogueHistory(newHistory);
                setUserInput('');
                setConversationCount(conversationCount + 1);
                
                if (critErrors.length > 0) {
                    setCriticalErrors([...criticalErrors, ...critErrors]);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
                const objectionsHandled = checkObjectionHandling(newHistory);
                if (objectionsHandled && client.currentProbability > 1 && Math.random() < 0.5) {
                    // 50% —à–∞–Ω—Å —Å–Ω–∏–∑–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞ 1
                    const newProbability = Math.max(1, client.currentProbability - 1);
                    setClient({ ...client, currentProbability: newProbability });
                }
                
                const clientResponse = await generateClientResponse(msg, critErrors.length > 0);
                setDialogueHistory([...newHistory, { speaker: 'client', text: clientResponse }]);
            };

            const handleFinishDialogue = () => {
                const agreement = analyzeClientAgreement(dialogueHistory, client.currentProbability);
                let willPay = false;
                let reason = "";
                
                // –õ–æ–≥–∏–∫–∞ —É—Å–ø–µ—Ö–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–π
                if (client.currentProbability === 4) {
                    willPay = false;
                    reason = '–ö–ª–∏–µ–Ω—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–≥–ª–∞—Å–∏—Ç—Å—è';
                } else if (client.currentProbability === 0) {
                    willPay = true;
                    reason = '–ö–ª–∏–µ–Ω—Ç –ª–µ–≥–∫–æ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è';
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ—Ç–∏–≤–∞—Ü–∏–π
                    const requiredMotivations = client.currentProbability;
                    if (motivationsCount >= requiredMotivations && agreement.agreed) {
                        willPay = true;
                        reason = `–£—Å–ø–µ—Ö: ${motivationsCount} –º–æ—Ç–∏–≤–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ`;
                    } else if (!agreement.agreed) {
                        willPay = false;
                        reason = agreement.reason;
                    } else {
                        willPay = false;
                        reason = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ—Ç–∏–≤–∞—Ü–∏–π (${motivationsCount}/${requiredMotivations})`;
                    }
                }
                
                setPaymentResult({ willPay, reason });
            };

            const handleArchetypeSelection = async (archetypeType) => {
                setSelectedArchetype(archetypeType);
                const caseId = `case_${Date.now()}`;
                
                try {
                    await supabaseClient.from('cases').insert({
                        case_id: caseId,
                        session_id: employee.sessionId,
                        employee: employee.fullName,
                        client: client.fullName,
                        client_data: client,
                        dialogue: dialogueHistory,
                        motivations_used: motivationsCount,
                        rudeness_count: criticalErrors.length,
                        rudeness_warnings: criticalErrors,
                        payment_result: paymentResult.willPay,
                        correct_archetype: client.archetype.type,
                        selected_archetype: archetypeType,
                        archetype_correct: archetypeType === client.archetype.type
                    });
                } catch (e) {
                    console.error('Error saving case:', e);
                }
            };

            if (!employee) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8 flex items-center justify-center">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
                            <div className="text-center mb-8">
                                <Icon name="login" size={64} className="mx-auto text-indigo-600 mb-4" />
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">–í—Ö–æ–¥ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä</h1>
                                <p className="text-gray-600">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</p>
                            </div>
                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                                <p className="text-sm text-blue-800">
                                    <strong>‚ÑπÔ∏è –í–∞–∂–Ω–æ:</strong> –í–æ–π–¥–∏—Ç–µ —Å –ª–æ–≥–∏–Ω–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º –∏–∑ –ø–∞–Ω–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è
                                </p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">–õ–æ–≥–∏–Ω</label>
                                    <input 
                                        type="text" 
                                        value={employeeForm.login} 
                                        onChange={(e) => setEmployeeForm({...employeeForm, login: e.target.value})} 
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg outline-none focus:border-indigo-500" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" 
                                        disabled={isLoading}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                                    <input 
                                        type="password" 
                                        value={employeeForm.password} 
                                        onChange={(e) => setEmployeeForm({...employeeForm, password: e.target.value})} 
                                        onKeyPress={(e) => e.key === 'Enter' && handleEmployeeLogin()} 
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg outline-none focus:border-indigo-500" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                                        disabled={isLoading}
                                    />
                                </div>
                                <button 
                                    onClick={handleEmployeeLogin} 
                                    disabled={isLoading} 
                                    className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-lg disabled:bg-gray-400 transition"
                                >
                                    {isLoading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!client) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <div className="flex justify-between items-center">
                                    <p className="text-xl font-bold text-indigo-600">{employee.fullName}</p>
                                    <button 
                                        onClick={handleLogout} 
                                        className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                                    >
                                        –í—ã–π—Ç–∏
                                    </button>
                                </div>
                            </div>
                            
                            <div className="text-center mb-8">
                                <h1 className="text-5xl font-bold text-gray-800 mb-4">–¢—Ä–µ–Ω–∞–∂—ë—Ä –≤–∑—ã—Å–∫–∞—Ç–µ–ª—è</h1>
                                <p className="text-xl text-gray-600 mb-6">
                                    –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ —Ä–∞–±–æ—Ç—ã —Å –¥–æ–ª–∂–Ω–∏–∫–∞–º–∏
                                </p>
                                
                                <button 
                                    onClick={() => setShowInfo(!showInfo)}
                                    className="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-700 mb-6"
                                >
                                    <Icon name="info" size={20} />
                                    <span className="font-medium">
                                        {showInfo ? '–°–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é' : '–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ'}
                                    </span>
                                </button>

                                {showInfo && (
                                    <div className="bg-white rounded-2xl shadow-xl p-8 mb-8 text-left">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                            üéØ –¶–µ–ª—å —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞
                                        </h2>
                                        <p className="text-gray-700 mb-6 leading-relaxed">
                                            –î–∞–Ω–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ —Ä–∞–±–æ—Ç—ã —Å –¥–æ–ª–∂–Ω–∏–∫–∞–º–∏. 
                                            –í—ã –±—É–¥–µ—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å AI-–∫–ª–∏–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏, 
                                            —É—á–∞—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –∏–∑–±–µ–≥–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ 
                                            –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è.
                                        </p>

                                        <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                            üë• –ê—Ä—Ö–µ—Ç–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
                                        </h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {archetypes.map(arch => (
                                                <div key={arch.type} className="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
                                                    <h3 className="font-bold text-indigo-600 mb-2">{arch.name}</h3>
                                                    <p className="text-sm text-gray-600">{arch.description}</p>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="mt-6 bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                            <p className="text-sm text-yellow-800">
                                                <strong>üí° –°–æ–≤–µ—Ç:</strong> –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è. 
                                                –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è, 
                                                —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —à–∞–Ω—Å—ã –Ω–∞ —É—Å–ø–µ—Ö!
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white rounded-2xl shadow-2xl p-12 text-center">
                                <Icon name="user" size={64} className="mx-auto text-indigo-600 mb-6" />
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                    –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?
                                </h2>
                                <button 
                                    onClick={startNewCase} 
                                    className="px-12 py-4 bg-indigo-600 text-white text-xl rounded-xl hover:bg-indigo-700 transition font-semibold shadow-lg"
                                >
                                    –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–ª—É—á–∞–π
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h2 className="text-xl font-bold">{client.fullName}</h2>
                                    <p className="text-sm text-gray-600">{client.age} –ª–µ—Ç</p>
                                    <p className="text-xs text-gray-500 mt-1">
                                        –°–ª–æ–∂–Ω–æ—Å—Ç—å: {client.currentProbability === 0 ? '–õ–µ–≥–∫–æ' : 
                                                   client.currentProbability === 1 ? '–°—Ä–µ–¥–Ω–µ' : 
                                                   client.currentProbability === 2 ? '–°–ª–æ–∂–Ω–æ' : 
                                                   client.currentProbability === 3 ? '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ' : 
                                                   '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ'}
                                    </p>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={backToHome} 
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                                    >
                                        <Icon name="home" size={18} />
                                    </button>
                                    <button 
                                        onClick={startNewCase} 
                                        className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                                    >
                                        <Icon name="refresh" size={18} />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-red-50 p-3 rounded-lg">
                                    <p className="font-bold text-red-700">{client.debt} USDT</p>
                                    <p className="text-xs text-red-600">–î–æ–ª–≥</p>
                                </div>
                                <div className="bg-orange-50 p-3 rounded-lg">
                                    <p className="font-bold text-orange-700">{client.overdueDays} –¥–Ω–µ–π</p>
                                    <p className="text-xs text-orange-600">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</p>
                                </div>
                                <div className="bg-indigo-50 p-3 rounded-lg">
                                    <p className="font-bold text-indigo-700">{motivationsCount}</p>
                                    <p className="text-xs text-indigo-600">–ú–æ—Ç–∏–≤–∞—Ü–∏–π</p>
                                </div>
                            </div>
                            
                            {criticalErrors.length > 0 && (
                                <div className="mt-4 bg-red-50 border-2 border-red-200 p-3 rounded-lg">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Icon name="alert" size={18} className="text-red-600" />
                                        <span className="font-bold text-red-800">
                                            –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏: {criticalErrors.length}
                                        </span>
                                    </div>
                                    <ul className="text-sm text-red-700 list-disc list-inside">
                                        {criticalErrors.map((err, idx) => (
                                            <li key={idx}>{err.name}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>

                        {!paymentResult ? (
                            <>
                                <div className="bg-white rounded-xl shadow-lg p-6 mb-4" style={{ height: '400px', display: 'flex', flexDirection: 'column' }}>
                                    <h3 className="text-lg font-bold mb-4">–î–∏–∞–ª–æ–≥</h3>
                                    
                                    <div className="flex-1 overflow-y-auto space-y-3 mb-4">
                                        {dialogueHistory.length === 0 && (
                                            <p className="text-center text-gray-500">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥...</p>
                                        )}
                                        
                                        {dialogueHistory.map((msg, idx) => (
                                            <div key={idx} className={msg.speaker === 'manager' ? 'text-right' : 'text-left'}>
                                                <div 
                                                    className={`inline-block p-3 rounded-lg max-w-[80%] break-words ${
                                                        msg.speaker === 'manager' 
                                                            ? msg.hasCriticalError 
                                                                ? 'bg-red-600 text-white' 
                                                                : 'bg-indigo-600 text-white' 
                                                            : 'bg-gray-100 text-gray-800'
                                                    }`}
                                                    style={{ wordWrap: 'break-word', overflowWrap: 'break-word' }}
                                                >
                                                    {msg.hasCriticalError && (
                                                        <div className="flex items-center gap-2 mb-1 pb-1 border-b border-red-400">
                                                            <Icon name="alert" size={16} className="text-white" />
                                                            <span className="text-xs font-bold">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</span>
                                                        </div>
                                                    )}
                                                    <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                                                    {msg.motivations && Object.keys(msg.motivations).length > 0 && (
                                                        <div className="mt-2 pt-2 border-t border-indigo-400">
                                                            <p className="text-xs opacity-90">
                                                                ‚úì –ú–æ—Ç–∏–≤–∞—Ü–∏–∏: {Object.values(msg.motivations).join(', ')}
                                                            </p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                        
                                        {isThinking && (
                                            <p className="text-gray-500 italic text-center">–ü–µ—á–∞—Ç–∞–µ—Ç...</p>
                                        )}
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={userInput} 
                                            onChange={(e) => setUserInput(e.target.value)} 
                                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} 
                                            placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                            className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg outline-none focus:border-indigo-500" 
                                            disabled={isThinking}
                                        />
                                        <button 
                                            onClick={handleSendMessage} 
                                            disabled={!userInput.trim() || isThinking} 
                                            className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 transition"
                                        >
                                            <Icon name="send" size={20} />
                                        </button>
                                    </div>
                                </div>
                                
                                {conversationCount >= 2 && (
                                    <button 
                                        onClick={handleFinishDialogue} 
                                        className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold transition"
                                    >
                                        –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥
                                    </button>
                                )}
                            </>
                        ) : !selectedArchetype ? (
                            <div className="bg-white rounded-xl shadow-lg p-8">
                                <h2 className="text-2xl font-bold mb-6 text-center">–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∞—Ä—Ö–µ—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    {archetypes.map(arch => (
                                        <button 
                                            key={arch.type} 
                                            onClick={() => handleArchetypeSelection(arch.type)} 
                                            className="p-4 bg-gray-50 hover:bg-indigo-50 border-2 border-gray-200 hover:border-indigo-300 rounded-lg transition"
                                        >
                                            <p className="font-bold text-lg mb-1">{arch.name}</p>
                                            <p className="text-sm text-gray-600">{arch.description}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-xl shadow-lg p-8 text-center">
                                <Icon 
                                    name={paymentResult.willPay ? "check" : "x"} 
                                    size={64} 
                                    className={`mx-auto mb-4 ${paymentResult.willPay ? 'text-green-600' : 'text-red-600'}`} 
                                />
                                <h2 className="text-3xl font-bold mb-4">
                                    {paymentResult.willPay ? '–£—Å–ø–µ—Ö!' : '–ù–µ—É–¥–∞—á–∞'}
                                </h2>
                                <p className="text-xl text-gray-700 mb-6">{paymentResult.reason}</p>
                                
                                <div className={`p-6 rounded-lg mb-6 ${
                                    selectedArchetype === client.archetype.type ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'
                                }`}>
                                    <p className="text-lg mb-2">
                                        <strong>–í—ã –≤—ã–±—Ä–∞–ª–∏:</strong> {archetypes.find(a => a.type === selectedArchetype)?.name}
                                    </p>
                                    <p className="text-lg">
                                        <strong>–ü—Ä–∞–≤–∏–ª—å–Ω–æ:</strong> {client.archetype.name}
                                    </p>
                                    {selectedArchetype === client.archetype.type && (
                                        <p className="text-green-700 font-semibold mt-2">‚úì –ê—Ä—Ö–µ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤–µ—Ä–Ω–æ!</p>
                                    )}
                                </div>

                                {criticalErrors.length > 0 && (
                                    <div className="bg-red-50 border-2 border-red-200 p-4 rounded-lg mb-6">
                                        <p className="font-bold text-red-800 mb-2">
                                            –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ ({criticalErrors.length}):
                                        </p>
                                        <ul className="text-sm text-red-700 text-left list-disc list-inside">
                                            {criticalErrors.map((err, idx) => (
                                                <li key={idx}>{err.name}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg mb-6">
                                    <p className="text-sm text-blue-800">
                                        <strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –º–æ—Ç–∏–≤–∞—Ü–∏–π:</strong> {motivationsCount}<br/>
                                        <strong>–¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –¥–ª—è —É—Å–ø–µ—Ö–∞:</strong> {client.agreementProbability === 0 ? '–õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ' : client.agreementProbability}
                                    </p>
                                </div>

                                <button 
                                    onClick={startNewCase} 
                                    className="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-lg transition"
                                >
                                    –ù–æ–≤—ã–π —Å–ª—É—á–∞–π
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DebtCollectionTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
